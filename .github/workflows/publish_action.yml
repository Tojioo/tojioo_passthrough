name: Publish to Comfy registry
on:
  workflow_run:
    workflows: [ "Changelog", "Bump version" ]
    types: [ completed ]

permissions:
  contents: read

concurrency:
  group: publish-${{ github.run_id }}
  cancel-in-progress: true

jobs:
  publish-node:
    if: |
      (github.event.workflow.name == 'Changelog' && github.event.workflow_run.conclusion == 'success') ||
      (github.event.workflow.name == 'Bump version' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Ensure run corresponds to main
        id: on_main
        shell: bash
        run: |
          set -euo pipefail
          # Resolve the SHA of the triggering run
          SHA="${{ github.event.workflow_run.head_sha }}"
          # Check if SHA is contained in origin/main
          if git fetch origin main:main && git merge-base --is-ancestor "$SHA" origin/main; then
            echo "ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "Triggering commit is not on main; skipping publish."
          fi
      - name: Determine if version changed (only for Bump version path)
        if: ${{ steps.on_main.outputs.ok == 'true' && github.event.workflow.name == 'Bump version' }}
        id: gate
        shell: bash
        run: |
          set -euo pipefail
          # If a tag v* points at the triggering SHA, then a version change occurred -> skip here, Changelog path will publish
          SHA="${{ github.event.workflow_run.head_sha }}"
          TAG=$(git tag --points-at "$SHA" --list 'v*' | head -n1 || true)
          if [ -n "$TAG" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Detected tag $TAG on this SHA; publishing will happen after Changelog."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "No version tag on this SHA; proceeding to publish directly (no version change)."
          fi
      - name: Stop if version change detected in Bump path
        if: ${{ steps.on_main.outputs.ok == 'true' && github.event.workflow.name == 'Bump version' && steps.gate.outputs.skip == 'true' }}
        run: echo "Skipping publish in Bump path because version changed; Changelog workflow will trigger publish."
      - name: Publish to registry
        if: ${{ steps.on_main.outputs.ok == 'true' && (github.event.workflow.name == 'Changelog' || (github.event.workflow.name == 'Bump version' && steps.gate.outputs.skip == 'false')) }}
        uses: Comfy-Org/publish-node-action@main
        with:
          personal_access_token: ${{ secrets.REGISTRY_ACCESS_TOKEN }}
